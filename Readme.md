# Проектная работа дисциплины DBOps

### Описание проекта

Учебный проект в рамках дисциплины "DBOps". Основная цель проекта — проектирование, оптимизация и анализ производительности базы данных для хранения информации о заказах, связанных продуктах и их продажах.

---

## Структура базы данных

### Изначальная структура

Изначально база данных состояла из следующих таблиц:

1. **Таблица `product`**  
   Основная информация о продуктах.  
   **Колонки**:
    - `id`: Уникальный идентификатор продукта.
    - `name`: Название продукта.
    - `picture_url`: URL изображения продукта (дополнительная информация).

2. **Таблица `product_info`**  
   Дополнительная информация о продуктах, включая цену.  
   **Колонки**:
    - `product_id`: Идентификатор продукта (ссылка на `product.id`).
    - `name`: Название продукта (дублирует `product.name`).
    - `price`: Цена продукта.

3. **Таблица `orders`**  
   Хранит информацию о заказах.  
   **Колонки**:
    - `id`: Уникальный идентификатор заказа.
    - `status`: Статус заказа (например, "в обработке", "доставлен").

4. **Таблица `orders_date`**  
   Дополнительные данные о заказах, такие как дата создания, дублирующие информацию из `orders`.  
   **Колонки**:
    - `order_id`: Идентификатор заказа (ссылка на `orders.id`).
    - `status`: Статус заказа.
    - `date_created`: Дата создания заказа (по умолчанию: текущая дата).

5. **Таблица `order_product`**  
   Связь между заказами и продуктами, указывающая количество каждого продукта в заказе.  
   **Колонки**:
    - `quantity`: Количество продукта в заказе.
    - `order_id`: Идентификатор заказа (ссылка на `orders.id`).
    - `product_id`: Идентификатор продукта (ссылка на `product.id`).

---

## Внесённые изменения

1. **Оптимизация таблицы `product`:**
    - Добавлен столбец `price` для хранения цены продукта. Теперь все данные о продукте хранятся в одной таблице, что позволило удалить таблицу `product_info`.
    - Добавлен первичный ключ (`PRIMARY KEY`) для столбца `id`.

2. **Оптимизация таблицы `orders`:**
    - Добавлен столбец `date_created` для хранения даты создания заказа (со значением по умолчанию `CURRENT_DATE`).
    - Добавлен первичный ключ (`PRIMARY KEY`) для столбца `id`.

3. **Оптимизация связей в таблице `order_product`:**
    - Добавлены внешние ключи:
        - `product_id` теперь ссылается на `product.id` (ограничение внешнего ключа `fk_product`).
        - `order_id` теперь ссылается на `orders.id` (ограничение внешнего ключа `fk_orders`).

4. **Удаление лишних таблиц:**
    - Удалена таблица `product_info`, так как данные из неё перенесены в `product`.
    - Удалена таблица `orders_date`, так как данные из неё перенесены в `orders`.

5. **Индексация таблиц:**
    - Созданы индексы для оптимизации производительности запросов:
        - Индекс на колонках `status, date_created` в таблице `orders` для ускорения фильтрации по статусу и дате заказа.
        - Индекс на колонке `order_id` в таблице `order_product` для ускорения соединения таблиц.

---

### Оптимизированная структура базы данных

1. **Таблица `product`:**
   Теперь содержит всю информацию о продукте, включая цену.  
   **Колонки**:
    - `id` (PRIMARY KEY): Уникальный идентификатор продукта.
    - `name`: Название продукта.
    - `picture_url`: URL изображения продукта.
    - `price`: Цена продукта.

2. **Таблица `orders`:**
   Теперь содержит данные о статусе заказа и дате его создания.  
   **Колонки**:
    - `id` (PRIMARY KEY): Уникальный идентификатор заказа.
    - `status`: Статус заказа.
    - `date_created`: Дата создания заказа.

3. **Таблица `order_product`:**
   Осталась без изменения, но добавлены внешние ключи для улучшения целостности данных.  
   **Колонки**:
    - `quantity`: Количество продукта в заказе.
    - `order_id` (FOREIGN KEY): Ссылается на `orders.id`.
    - `product_id` (FOREIGN KEY): Ссылается на `product.id`.

---

## Наполнение базы данных

1. **Продукты (`product`):**
    - Содержит информацию о продуктах, включая их название, ссылку на изображение и цену. Эти данные можно вносить вручную или автоматически через систему управления товарами.

2. **Заказы (`orders`):**
    - Заказы создаются с указанием текущего статуса, а дата их создания (`date_created`) заполняется автоматически.

3. **Состав заказа (`order_product`):**
    - В эту таблицу записываются сведения о товарах, включённых в каждый заказ, их количестве и связях с продуктами.

---

## Создание и управление базой данных

1. **Создание базы данных:**
   Создана база данных `store` (пароль скрыт в целях безопасности):

   ```bash
   export PGPASSWORD='password1'
   psql -U admin_9qml -h localhost -d postgres -c 'CREATE DATABASE store;'
   ```

2. **Добавление пользователя:**
   Создан пользователя `migration_service_9qml` для выполнения миграций и тестов (пароль скрыт в целях безопасности):

   ```bash
   psql -U admin_9qml -h localhost -d store
   CREATE ROLE migration_service_9qml WITH LOGIN PASSWORD 'password2';
   GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO migration_service_9qml;
   GRANT CREATE ON SCHEMA public TO migration_service_9qml;
   ```

3. **Пользователь для проверки базы данных:**
   Пользователь `operator` с правами только чтения уже добавлен для проверки структуры и содержимого базы данных ревьюером.  
   **Учётные данные:**
   - Имя пользователя: `operator`
   - Пароль: `PXKzF5`
   - Привилегии:
      - Доступ только на чтение (`SELECT`) ко всем таблицам в схеме `public`.


---

## Запросы и производительность

### Пример запроса: количество сосисок было продано за каждый день предыдущей недели

```sql
SELECT o.date_created, SUM(op.quantity)
FROM orders AS o
JOIN order_product AS op ON o.id = op.order_id
WHERE o.status = 'shipped' 
  AND o.date_created > NOW() - INTERVAL '7 DAY'
GROUP BY o.date_created;
```

Этот запрос определяет количество проданных единиц товаров за каждый день предыдущей недели. Оптимизированная структура базы данных и добавленные индексы позволяют выполнять такие запросы значительно быстрее.

---

## Результат оптимизации

- **До оптимизации:**
    - Запросы выполнялись медленно из-за отсутствия индексов и большого объёма данных в избыточных таблицах.
    - Некоторым запросам требовалось более 130 секунд на выполнение.

- **После оптимизации:**
    - Устранены избыточные таблицы, что упростило структуру базы данных.
    - Добавлены индексы, сократившие время выполнения основного запроса до 39 секунд.
    - Улучшена целостность данных за счёт добавления первичных и внешних ключей.

---

## Заключение

Проект продемонстрировал полный процесс работы с базой данных:
1. Определение избыточных данных и сложности структуры.
2. Перенос данных, добавление новых колонок и удаление избыточных таблиц.
3. Добавление индексов и внешних ключей для улучшения производительности и целостности данных.
4. Тестирование производительности запросов после оптимизации.

Оптимизированная структура базы данных не только ускоряет выполнение запросов, но и упрощает поддержку и дальнейшее развитие системы.